<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸å†’éšªå³¶ï¼šåˆ†æ•¸çš„è¨ˆç®—</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #ecfeff; }
        .font-game { font-family: 'Fredoka', sans-serif; }
        
        /* éŠæˆ²åŒ–å‹•ç•« */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* åœ°åœ–è·¯å¾‘ç·šæ¢ */
        .map-path {
            position: absolute;
            z-index: 0;
            border: 4px dashed #94a3b8;
        }
        
        /* ç§˜ç¬ˆå·è»¸å‹•ç•« */
        @keyframes unfurl {
            0% { transform: scaleY(0); opacity: 0; }
            100% { transform: scaleY(1); opacity: 1; }
        }
        .animate-unfurl { transform-origin: top; animation: unfurl 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- åœ–ç¤º (Icons) ---
        const IconStar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clipRule="evenodd" /></svg>;
        const IconLock = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clipRule="evenodd" /></svg>;
        const IconCheck = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className={className}><polyline points="20 6 9 17 4 12" /></svg>;
        const IconHome = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>;
        const IconSettings = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconBarChart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>;
        const IconBook = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533zM12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.477V5.25c0-.655-.45-1.205-1.082-1.327A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z" /></svg>;

        // --- é—œå¡è³‡æ–™çµæ§‹ ---
        const LEVELS = [
            {
                id: 1,
                name: "æ•´æ•¸ Ã— åˆ†æ•¸æ‘",
                desc: "å­¸ç¿’å°‡æ•´æ•¸ä¹˜ä»¥åˆ†æ•¸ï¼Œåƒæ˜¯åˆ†æŠ«è–©ä¸€æ¨£ç°¡å–®ï¼",
                icon: "ğŸ•",
                color: "bg-orange-100 border-orange-400",
                btnColor: "bg-orange-500",
                badge: "ğŸ• åˆ†æ•¸å€å¤§å¸«",
                subLevels: [
                    { id: "1-1", title: "åˆ†ä¸€åˆ†ä»»å‹™", type: "visual-pizza", q: "3 å€‹æŠ«è–©çš„ 1/4 æ˜¯å¤šå°‘å€‹æŠ«è–©ï¼Ÿ", total: 3, div: 4, ans: "3/4", options: ["3/4", "1/4", "4/3", "3"] },
                    { id: "1-2", title: "ç®—ä¸€ç®—ä»»å‹™", type: "quiz-basic", q: "5 Ã— 2/3 = ?", options: ["10/3", "7/3", "5/3", "10"], ans: "10/3", hint: "æ•´æ•¸åªè·Ÿåˆ†å­ç›¸ä¹˜å–”ï¼" },
                    { id: "1-BOSS", title: "æ‘èŠå®ˆè­·è€…", type: "boss", q: "ä¸€æ¢ç¹©å­é•· 8 å…¬å°ºï¼Œç”¨æ‰ 3/4ï¼Œè«‹å•ç”¨æ‰å¹¾å…¬å°ºï¼Ÿ", options: ["6å…¬å°º", "2å…¬å°º", "24/4å…¬å°º", "5å…¬å°º"], ans: "6å…¬å°º", hint: "8 Ã— 3/4 = 24/4 = 6" }
                ]
            },
            {
                id: 2,
                name: "åˆ†æ•¸ Ã— åˆ†æ•¸æ–¹æ ¼åŸ",
                desc: "é€²å…¥æ–¹æ ¼åŸï¼Œç”¨é¢ç©åœ–è§£åˆ†æ•¸ä¹˜æ³•ï¼",
                icon: "ğŸŸ¦",
                color: "bg-blue-100 border-blue-400",
                btnColor: "bg-blue-500",
                badge: "ğŸŸ¦ é¢ç©ç‹è€…",
                subLevels: [
                    { id: "2-1", title: "å¡—è‰²è¨“ç·´", type: "visual-grid", q: "å…ˆå¡— 1/2 (è—)ï¼Œå†å¡—å…¶ä¸­çš„ 1/2 (ç´…)ï¼Œé‡ç–Šè™•æ˜¯å¤šå°‘ï¼Ÿ", r: 1, c: 2, r2: 1, c2: 2, ans: "1/4", options: ["1/4", "1/2", "3/4", "1"] },
                    { id: "2-2", title: "ç®—å¼é…å°", type: "quiz-basic", q: "2/5 Ã— 3/4 çš„ç®—å¼æ„ç¾©æ˜¯ï¼Ÿ", options: ["2/5 çš„ 3/4 å€", "2/5 åŠ  3/4", "3/4 çš„ 2/5 å€", "ä»¥ä¸Šçš†é"], ans: "2/5 çš„ 3/4 å€", hint: "ä¹˜è™Ÿå¯ä»¥çœ‹ä½œã€çš„ã€" },
                    { id: "2-BOSS", title: "åŸä¸»æŒ‘æˆ°", type: "boss", q: "ä¸€å¡Šåœ° 4/5 å…¬é ƒï¼Œç¨®èŠ±ç”¨å»å…¶ä¸­çš„ 1/2ï¼Œç¨®èŠ±é¢ç©æ˜¯å¤šå°‘å…¬é ƒï¼Ÿ", options: ["2/5", "4/10", "0.4", "ä»¥ä¸Šçš†æ˜¯"], ans: "ä»¥ä¸Šçš†æ˜¯", hint: "4/5 Ã— 1/2 = 4/10 = 2/5 = 0.4" }
                ]
            },
            {
                id: 3,
                name: "å¤§å°åˆ¤æ–·ç ”ç©¶æ‰€",
                desc: "ä¸ç”¨ç®—ä¹Ÿèƒ½çŸ¥é“ç­”æ¡ˆè®Šå¤§é‚„æ˜¯è®Šå°ï¼",
                icon: "ğŸ”",
                color: "bg-purple-100 border-purple-400",
                btnColor: "bg-purple-500",
                badge: "ğŸ” å…ˆçŸ¥å¾½ç« ",
                subLevels: [
                    { id: "3-1", title: "å¿«é–ƒåˆ¤æ–·", type: "logic-compare", q: "10 Ã— 2/3", base: 10, mult: 2/3, options: ["è®Šå¤§", "è®Šå°", "ä¸è®Š"], ans: "è®Šå°" },
                    { id: "3-2", title: "é™·é˜±é¡Œ", type: "logic-compare", q: "5/6 Ã— 8/7", base: 5/6, mult: 8/7, options: ["æ¯” 5/6 å¤§", "æ¯” 5/6 å°", "ä¸€æ¨£å¤§"], ans: "æ¯” 5/6 å¤§" },
                    { id: "3-BOSS", title: "æ‰€é•·è€ƒæ ¸", type: "boss", q: "ä¸‹åˆ—å“ªå€‹ç®—å¼çš„ç© æ¯”è¢«ä¹˜æ•¸å¤§ï¼Ÿ", options: ["3/4 Ã— 1/2", "3/4 Ã— 1", "3/4 Ã— 4/3", "3/4 Ã— 0.9"], ans: "3/4 Ã— 4/3", hint: "ä¹˜æ•¸å¤§æ–¼ 1ï¼Œç©æ‰æœƒè®Šå¤§ï¼" }
                ]
            },
            {
                id: 4,
                name: "åˆ†æ•¸ Ã· æ•´æ•¸åˆ†é…ç«™",
                desc: "å­¸æœƒå…¬å¹³åˆ†é…ï¼ŒæŠŠæœæ±åˆ†çµ¦å¤§å®¶ï¼",
                icon: "ğŸ§ƒ",
                color: "bg-green-100 border-green-400",
                btnColor: "bg-green-500",
                badge: "ğŸ§ƒ åˆ†é…å¤§å¸«",
                subLevels: [
                    { id: "4-1", title: "å€’æœæ±ä»»å‹™", type: "visual-juice", q: "4/5 å…¬å‡æœæ±ï¼Œå¹³åˆ†çµ¦ 2 äººï¼Œæ¯äººå–å¤šå°‘ï¼Ÿ", amount: 4, div: 2, ans: "2/5", options: ["2/5", "4/5", "1/5", "2/10"] },
                    { id: "4-2", title: "ç®—å¼è½‰æ›", type: "quiz-basic", q: "6/7 Ã· 3 å¯ä»¥å¯«æˆï¼Ÿ", options: ["6/7 Ã— 3", "6/7 Ã— 1/3", "3/7 Ã— 6", "7/6 Ã— 3"], ans: "6/7 Ã— 1/3", hint: "é™¤ä»¥æ•´æ•¸ = ä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€" },
                    { id: "4-BOSS", title: "ç«™é•·é©—æ”¶", type: "boss", q: "ä¸€æ¢ç·å¸¶é•· 3 åˆ 1/5 å…¬å°ºï¼Œå¹³åˆ†å‰ªæˆ 4 æ®µï¼Œæ¯æ®µé•·å¹¾å…¬å°ºï¼Ÿ", options: ["4/5", "16/5", "3/5", "16/20"], ans: "4/5", hint: "å…ˆæ›å‡åˆ†æ•¸ï¼š16/5 Ã· 4 = 16/5 Ã— 1/4 = 4/5" }
                ]
            }
        ];

        // --- è¦–è¦ºåŒ–çµ„ä»¶ ---

        // 1. æŠ«è–©è¦–è¦ºåŒ–
        const PizzaVisual = ({ total, div }) => {
            return (
                <div className="flex flex-wrap justify-center gap-4 py-6">
                    {Array.from({ length: total }).map((_, i) => (
                        <div key={i} className="relative w-24 h-24 bg-yellow-200 rounded-full border-4 border-yellow-500 overflow-hidden shadow-lg animate-pop" style={{animationDelay: `${i*0.1}s`}}>
                            <div className="absolute inset-0 border-r-2 border-yellow-600" style={{left: '50%'}}></div>
                            <div className="absolute inset-0 border-b-2 border-yellow-600" style={{top: '50%'}}></div>
                            {/* Highlight 1 slice */}
                            <div className="absolute top-0 right-0 w-1/2 h-1/2 bg-red-400 opacity-60 rounded-tr-full"></div>
                        </div>
                    ))}
                    <div className="w-full text-center text-lg text-orange-700 font-bold mt-2">
                        {total} å€‹æŠ«è–©ï¼Œæ¯å€‹åˆ‡æˆ 4 ä»½ï¼Œå–å…¶ä¸­ 1 ä»½<br/>
                        å…±å–äº† {total} å€‹ 1/4 = {total}/4
                    </div>
                </div>
            );
        };

        // 2. æ–¹æ ¼è¦–è¦ºåŒ–
        const GridVisual = () => {
            return (
                <div className="flex flex-col items-center py-6">
                    <div className="relative w-48 h-48 border-4 border-gray-800 bg-white grid grid-cols-2 grid-rows-2">
                        {/* 1/2 è—è‰²ç›´æ¢ */}
                        <div className="absolute left-0 top-0 bottom-0 w-1/2 bg-blue-300 opacity-50"></div>
                        {/* 1/2 ç´…è‰²æ©«æ¢ (åªåœ¨è—è‰²å€åŸŸå…§æœ‰æ•ˆï¼Œæ¨¡æ“¬åˆ†æ•¸ä¹˜åˆ†æ•¸) */}
                        <div className="absolute left-0 top-0 right-0 h-1/2 bg-red-300 opacity-50"></div>
                        
                        {/* ç¶²æ ¼ç·š */}
                        <div className="border border-gray-300 w-full h-full"></div>
                        <div className="border border-gray-300 w-full h-full"></div>
                        <div className="border border-gray-300 w-full h-full"></div>
                        <div className="border border-gray-300 w-full h-full"></div>
                        
                        {/* é‡ç–Šå€å¼·èª¿ */}
                        <div className="absolute left-0 top-0 w-1/2 h-1/2 bg-purple-500 opacity-60 flex items-center justify-center text-white font-bold text-xl animate-pulse">
                            ?
                        </div>
                    </div>
                    <p className="mt-4 text-gray-600">è—è‰²æ˜¯ 1/2ï¼Œç´…è‰²æ˜¯è—è‰²çš„ 1/2</p>
                </div>
            );
        };

        // 3. æœæ±è¦–è¦ºåŒ–
        const JuiceVisual = ({ amount, div }) => {
            return (
                <div className="flex flex-col items-center py-6">
                    <div className="relative w-32 h-48 border-x-4 border-b-4 border-gray-400 rounded-b-xl bg-white overflow-hidden mb-4">
                        <div className="absolute bottom-0 w-full bg-green-400 transition-all duration-1000" style={{ height: `${(amount/5)*100}%` }}></div>
                        <div className="absolute w-full border-t border-gray-300 top-1/5 text-xs text-right pr-1">4/5</div>
                        <div className="absolute w-full border-t border-gray-300 top-2/5 text-xs text-right pr-1">3/5</div>
                        <div className="absolute w-full border-t border-gray-300 top-3/5 text-xs text-right pr-1">2/5</div>
                        <div className="absolute w-full border-t border-gray-300 top-4/5 text-xs text-right pr-1">1/5</div>
                    </div>
                    <div className="text-2xl font-bold mb-2">Ã· {div}</div>
                    <div className="flex gap-4">
                        <div className="w-16 h-24 border-x-2 border-b-2 border-gray-400 rounded-b-lg relative overflow-hidden">
                             <div className="absolute bottom-0 w-full bg-green-400 h-2/5 opacity-50"></div>
                        </div>
                        <div className="w-16 h-24 border-x-2 border-b-2 border-gray-400 rounded-b-lg relative overflow-hidden">
                             <div className="absolute bottom-0 w-full bg-green-400 h-2/5 opacity-50"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»è¦çµ„ä»¶ ---

        function App() {
            const [screen, setScreen] = useState('welcome'); // welcome, map, level, report
            const [userData, setUserData] = useState({ name: '', unlocked: 1, coins: 0, badges: [], history: [] });
            const [currentLevelId, setCurrentLevelId] = useState(null);
            const [currentSubLevelIndex, setCurrentSubLevelIndex] = useState(0);
            const [tempName, setTempName] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showSecretBook, setShowSecretBook] = useState(false);
            const [gasUrl, setGasUrl] = useState("https://script.google.com/macros/s/AKfycbxr4w817Y7RjYRDFVKJtJiAdpLZTqWmSpJBHtP-GJqPaqnHj_PKczSkkYJZtM6JJ1E/exec");

            // åˆå§‹åŒ–è®€å–
            useEffect(() => {
                const saved = localStorage.getItem('fractionAdventureUser');
                if (saved) setUserData(JSON.parse(saved));
                const savedUrl = localStorage.getItem('fractionAdventureGasUrl');
                if (savedUrl) setGasUrl(savedUrl);
            }, []);

            // å­˜æª”
            const saveData = (newData) => {
                const updated = { ...userData, ...newData };
                setUserData(updated);
                localStorage.setItem('fractionAdventureUser', JSON.stringify(updated));
            };

            const startApp = () => {
                if (!tempName.trim()) return;
                saveData({ name: tempName });
                setScreen('map');
            };

            // é€²å…¥é—œå¡
            const enterLevel = (levelId) => {
                if (levelId > userData.unlocked) return;
                setCurrentLevelId(levelId);
                setCurrentSubLevelIndex(0);
                setScreen('level');
            };

            // è™•ç†ç­”é¡Œ
            const handleAnswer = (isCorrect, questionText, userAnswer, correctAnswer) => {
                // è¨˜éŒ„
                const newRecord = {
                    time: new Date().toLocaleString(),
                    level: `${currentLevelId}-${currentSubLevelIndex+1}`,
                    q: questionText,
                    userAns: userAnswer,
                    isCorrect: isCorrect
                };
                
                const updatedHistory = [newRecord, ...userData.history];
                let updatedCoins = userData.coins;
                
                if (isCorrect) updatedCoins += 10;

                saveData({ history: updatedHistory, coins: updatedCoins });

                if (isCorrect) {
                    // ä¸‹ä¸€å°é—œ
                    const currentLevelData = LEVELS.find(l => l.id === currentLevelId);
                    if (currentSubLevelIndex < currentLevelData.subLevels.length - 1) {
                        setTimeout(() => setCurrentSubLevelIndex(p => p + 1), 1000);
                    } else {
                        // é€šé—œè©²å¤§é—œå¡
                        completeLevel(currentLevelId);
                    }
                }
            };

            const completeLevel = (levelId) => {
                const levelData = LEVELS.find(l => l.id === levelId);
                let newUnlocked = userData.unlocked;
                let newBadges = [...userData.badges];

                // è§£é–ä¸‹ä¸€é—œ
                if (levelId === userData.unlocked && levelId < 4) {
                    newUnlocked = levelId + 1;
                }
                
                // ç²å¾—å¾½ç« 
                if (!newBadges.includes(levelData.badge)) {
                    newBadges.push(levelData.badge);
                }

                saveData({ unlocked: newUnlocked, badges: newBadges, coins: userData.coins + 50 }); // Boss bonus
                setTimeout(() => {
                    alert(`ğŸ‰ æ­å–œé€šé—œï¼ç²å¾—å¾½ç« ï¼š${levelData.badge}\nè§£é–ä¸‹ä¸€å€åŸŸï¼`);
                    setScreen('map');
                }, 1000);
            };

            // ä¸Šå‚³ GAS
            const submitToGAS = async () => {
                if (!gasUrl) return;
                const payload = {
                    name: userData.name,
                    score: userData.coins, // é€™è£¡ç”¨é‡‘å¹£ç•¶åˆ†æ•¸
                    correctCount: userData.badges.length, // ç”¨å¾½ç« æ•¸ç•¶ç­”å°æŒ‡æ¨™(ç¤ºæ„)
                    totalCount: 4,
                    details: `[åˆ†æ•¸å†’éšªå³¶] å·²è§£é–è‡³ç¬¬ ${userData.unlocked} é—œ, å¾½ç« : ${userData.badges.join(',')}`
                };

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    alert('âœ… å†’éšªé€²åº¦å·²ä¸Šå‚³çµ¦è€å¸«ï¼');
                } catch (e) {
                    alert('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
                }
            };

            // --- ç•«é¢æ¸²æŸ“ ---

            // 1. æ­¡è¿ç•«é¢
            if (screen === 'welcome') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-cyan-300 to-blue-500 p-4">
                        <div className="bg-white rounded-3xl p-10 max-w-md w-full shadow-2xl text-center border-4 border-white/50 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-4 bg-yellow-400"></div>
                            <div className="text-6xl mb-4 animate-float">ğŸï¸</div>
                            <h1 className="text-4xl font-game font-bold text-cyan-700 mb-2">åˆ†æ•¸å†’éšªå³¶</h1>
                            <p className="text-gray-500 mb-8">Fraction Island Adventure</p>
                            
                            <input
                                type="text"
                                placeholder="è¼¸å…¥å†’éšªè€…å§“å"
                                className="w-full p-4 bg-gray-100 rounded-xl mb-4 text-center text-xl outline-none focus:ring-4 ring-cyan-200 transition"
                                value={tempName}
                                onChange={e => setTempName(e.target.value)}
                            />
                            
                            <button onClick={startApp} className="w-full py-4 bg-yellow-400 text-yellow-900 rounded-xl font-bold text-2xl shadow-lg hover:bg-yellow-300 hover:scale-105 transition transform">
                                é–‹å§‹å†’éšª â–¶
                            </button>

                            <div className="mt-6 text-sm text-gray-400 cursor-pointer hover:text-cyan-600" onClick={() => setShowSettings(!showSettings)}>
                                <IconSettings className="inline w-4 h-4 mr-1"/> è¨­å®š
                            </div>
                            {showSettings && (
                                <input 
                                    type="text" 
                                    className="w-full mt-2 p-2 border text-xs" 
                                    value={gasUrl} 
                                    onChange={e => {setGasUrl(e.target.value); localStorage.setItem('fractionAdventureGasUrl', e.target.value)}}
                                />
                            )}
                        </div>
                    </div>
                );
            }

            // 2. åœ°åœ–ç•«é¢
            if (screen === 'map') {
                return (
                    <div className="min-h-screen bg-[#a5f3fc] relative overflow-hidden flex flex-col">
                        {/* é ‚éƒ¨è³‡è¨Šæ¬„ */}
                        <div className="bg-white/90 backdrop-blur p-4 flex justify-between items-center shadow-md z-10">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                    {userData.name[0]}
                                </div>
                                <div>
                                    <div className="font-bold text-gray-800">{userData.name}</div>
                                    <div className="text-xs text-gray-500">Lv. {userData.unlocked} æ¢éšªå®¶</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-full border border-yellow-300">
                                    <div className="text-yellow-600">â­</div>
                                    <span className="font-bold text-yellow-700">{userData.coins}</span>
                                </div>
                                <button onClick={() => setScreen('report')} className="bg-gray-100 p-2 rounded-full hover:bg-gray-200">
                                    <IconBarChart className="w-6 h-6 text-gray-600" />
                                </button>
                            </div>
                        </div>

                        {/* ç§˜ç¬ˆæŒ‰éˆ• */}
                        <div className="absolute top-20 right-6 z-20">
                            <button 
                                onClick={() => setShowSecretBook(true)}
                                className="bg-purple-600 text-white p-3 rounded-full shadow-lg hover:bg-purple-700 hover:scale-110 transition flex flex-col items-center gap-1"
                            >
                                <IconBook className="w-8 h-8" />
                                <span className="text-xs font-bold">é—–é—œç§˜ç¬ˆ</span>
                            </button>
                        </div>

                        {/* ç§˜ç¬ˆå½ˆçª— */}
                        {showSecretBook && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowSecretBook(false)}>
                                <div className="bg-[#fff9c4] w-full max-w-lg rounded-xl shadow-2xl p-8 relative animate-unfurl border-8 border-[#d4a373]" onClick={e => e.stopPropagation()}>
                                    <button onClick={() => setShowSecretBook(false)} className="absolute top-4 right-4 text-2xl text-amber-800 hover:text-amber-950 font-bold">âœ•</button>
                                    
                                    <h2 className="text-3xl font-bold text-amber-900 text-center mb-6 border-b-2 border-amber-300 pb-2">ğŸ“œ å¢åŠ å¯¦åŠ›å·è»¸</h2>
                                    
                                    <div className="space-y-6 text-amber-900">
                                        <div className="bg-white/60 p-4 rounded-lg border border-amber-200">
                                            <h3 className="text-xl font-bold mb-2 flex items-center">âœ¨ è¢«ä¹˜æ•¸ã€ä¹˜æ•¸èˆ‡ç©çš„é—œä¿‚</h3>
                                            <p className="text-sm mb-3 text-amber-800">
                                                ç•¶ä¸€å€‹æ•¸ï¼ˆè¢«ä¹˜æ•¸ï¼‰ä¹˜ä»¥å¦ä¸€å€‹æ•¸ï¼ˆä¹˜æ•¸ï¼‰æ™‚ï¼Œç©æœƒè®Šå¤§é‚„æ˜¯è®Šå°ï¼Ÿ
                                                <br/>
                                                <span className="font-bold">é—œéµçœ‹ã€Œä¹˜æ•¸ã€æ˜¯æ¯” 1 å¤§é‚„æ˜¯æ¯” 1 å°ï¼</span>
                                            </p>
                                            
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-3">
                                                    <span className="bg-red-100 text-red-600 font-bold px-2 py-1 rounded">è®Šå¤§</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold">ä¹˜æ•¸ &gt; 1</div>
                                                        <div className="text-xs text-gray-500">ä¾‹ï¼š5 Ã— <span className="text-red-500 font-bold">1.2</span> = 6 (6 æ¯” 5 å¤§)</div>
                                                    </div>
                                                    <span className="text-2xl">ğŸ“ˆ</span>
                                                </div>
                                                
                                                <div className="flex items-center gap-3">
                                                    <span className="bg-gray-200 text-gray-600 font-bold px-2 py-1 rounded">ä¸è®Š</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold">ä¹˜æ•¸ = 1</div>
                                                        <div className="text-xs text-gray-500">ä¾‹ï¼š5 Ã— <span className="text-gray-500 font-bold">1</span> = 5</div>
                                                    </div>
                                                    <span className="text-2xl">âš–ï¸</span>
                                                </div>

                                                <div className="flex items-center gap-3">
                                                    <span className="bg-green-100 text-green-600 font-bold px-2 py-1 rounded">è®Šå°</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold">ä¹˜æ•¸ &lt; 1</div>
                                                        <div className="text-xs text-gray-500">ä¾‹ï¼š5 Ã— <span className="text-green-500 font-bold">0.8</span> = 4 (4 æ¯” 5 å°)</div>
                                                    </div>
                                                    <span className="text-2xl">ğŸ“‰</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-amber-100 p-4 rounded-lg text-center">
                                            <div className="font-bold text-lg mb-1">ğŸ“¢ è¶…å¼·è¨˜æ†¶å£è¨£</div>
                                            <p className="text-amber-800">
                                                ã€Œä¹˜æ•¸<span className="text-red-600 font-bold text-xl">å¤§</span>æ–¼ 1ï¼Œç©å°±è®Š<span className="text-red-600 font-bold text-xl">å¤§</span>ï¼ã€<br/>
                                                ã€Œä¹˜æ•¸<span className="text-green-600 font-bold text-xl">å°</span>æ–¼ 1ï¼Œç©å°±è®Š<span className="text-green-600 font-bold text-xl">å°</span>ï¼ã€
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-6 text-center text-sm text-amber-700/60 font-bold">
                                        - å†’éšªè€…å…¬æœƒ è£½ -
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* åœ°åœ–å€åŸŸ */}
                        <div className="flex-1 relative flex items-center justify-center p-8 overflow-y-auto">
                            <div className="relative w-full max-w-2xl h-[600px] bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-[#cffafe] rounded-[50px] shadow-[inset_0_0_60px_rgba(0,0,0,0.1)] border-8 border-white/50 p-10">
                                {/* è£é£¾èƒŒæ™¯ */}
                                <div className="absolute top-10 left-10 text-6xl opacity-20 animate-float">â˜ï¸</div>
                                <div className="absolute bottom-20 right-20 text-6xl opacity-20 animate-float" style={{animationDelay:'1s'}}>â˜ï¸</div>

                                {/* é—œå¡è·¯å¾‘ */}
                                <div className="absolute left-1/2 top-20 bottom-20 w-1 border-l-4 border-dashed border-cyan-400/50 -translate-x-1/2"></div>

                                <div className="flex flex-col gap-12 items-center relative z-10 h-full justify-between">
                                    {LEVELS.map((level, idx) => {
                                        const isUnlocked = level.id <= userData.unlocked;
                                        const isCompleted = level.id < userData.unlocked;
                                        
                                        return (
                                            <button 
                                                key={level.id}
                                                onClick={() => enterLevel(level.id)}
                                                disabled={!isUnlocked}
                                                className={`
                                                    relative w-full max-w-md p-4 rounded-2xl flex items-center gap-4 transition-all duration-300 border-b-8 group
                                                    ${isUnlocked 
                                                        ? `${level.color} hover:scale-105 active:scale-95 active:border-b-0 active:translate-y-2 cursor-pointer shadow-lg` 
                                                        : 'bg-gray-200 border-gray-400 opacity-70 cursor-not-allowed grayscale'}
                                                `}
                                            >
                                                <div className={`w-16 h-16 rounded-xl flex items-center justify-center text-3xl shadow-inner ${isUnlocked ? 'bg-white' : 'bg-gray-300'}`}>
                                                    {isUnlocked ? level.icon : <IconLock className="w-8 h-8 text-gray-500"/>}
                                                </div>
                                                <div className="flex-1 text-left">
                                                    <h3 className="font-bold text-xl text-gray-800">{level.name}</h3>
                                                    <p className="text-sm text-gray-600">{level.desc}</p>
                                                </div>
                                                {isCompleted && (
                                                    <div className="bg-green-500 text-white p-1 rounded-full">
                                                        <IconCheck className="w-6 h-6" />
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 3. é—œå¡ç•«é¢
            if (screen === 'level') {
                const levelData = LEVELS.find(l => l.id === currentLevelId);
                const qData = levelData.subLevels[currentSubLevelIndex];
                const isBoss = qData.type === 'boss';

                return (
                    <div className={`min-h-screen flex flex-col ${isBoss ? 'bg-red-50' : 'bg-white'}`}>
                        {/* Header */}
                        <div className="p-4 flex justify-between items-center border-b-2 border-gray-100">
                            <button onClick={() => setScreen('map')} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded-lg flex items-center gap-1">
                                <IconHome className="w-5 h-5"/> é›¢é–‹
                            </button>
                            <div className="font-bold text-lg text-gray-700">
                                é—œå¡ {currentLevelId}-{currentSubLevelIndex + 1}ï¼š{qData.title}
                            </div>
                            <div className="w-16"></div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 flex flex-col items-center justify-center p-6 max-w-3xl mx-auto w-full">
                            {isBoss && <div className="text-red-500 font-bold text-2xl mb-4 animate-bounce">ğŸ”¥ BOSS æŒ‘æˆ° ğŸ”¥</div>}
                            
                            <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center leading-relaxed">
                                {qData.q}
                            </h2>

                            {/* è¦–è¦ºåŒ–å€åŸŸ */}
                            <div className="w-full mb-8 min-h-[150px] flex justify-center bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                {qData.type === 'visual-pizza' && <PizzaVisual total={qData.total} div={qData.div} />}
                                {qData.type === 'visual-grid' && <GridVisual />}
                                {qData.type === 'visual-juice' && <JuiceVisual amount={qData.amount} div={qData.div} />}
                                {qData.type === 'logic-compare' && (
                                    <div className="text-6xl font-bold text-purple-600 flex gap-4 items-center">
                                        <span>{qData.base}</span> 
                                        <span className="text-gray-400">Ã—</span> 
                                        <span>{qData.mult.toFixed(2)}</span>
                                    </div>
                                )}
                                {(qData.type === 'quiz-basic' || isBoss) && (
                                    <div className="text-gray-400 flex items-center justify-center h-full">
                                        è«‹ç›´æ¥ä½œç­” ğŸ‘‡
                                    </div>
                                )}
                            </div>

                            {/* é¸é …å€ */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                                {/* ä¿®æ”¹è™•ï¼šç§»é™¤å¯«æ­»çš„é¸é …ï¼Œæ”¹ç”¨ qData.options */}
                                {qData.options && qData.options.map((opt, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => {
                                            const correct = opt === qData.ans;
                                            if(correct) {
                                                alert('âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼');
                                                handleAnswer(true, qData.q, opt, qData.ans);
                                            } else {
                                                alert(`âŒ å“å‘€éŒ¯äº†ï¼${qData.hint ? '\nğŸ’¡ æç¤ºï¼š' + qData.hint : ''}`);
                                            }
                                        }}
                                        className={`py-4 rounded-xl border-b-4 text-xl font-bold transition active:border-b-0 active:translate-y-1 ${levelData.color.replace('bg-', 'hover:bg-').replace('border-', 'hover:border-')} bg-white border-gray-300`}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // 4. æˆç¸¾å–®ç•«é¢
            if (screen === 'report') {
                return (
                    <div className="min-h-screen bg-gray-50 p-8 flex flex-col items-center">
                        <div className="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-3xl font-bold text-gray-800">å†’éšªè€…æª”æ¡ˆ</h2>
                                <button onClick={() => setScreen('map')} className="text-gray-500 hover:text-gray-800">é—œé–‰ âœ•</button>
                            </div>

                            <div className="flex items-center gap-6 mb-8">
                                <div className="w-24 h-24 bg-gradient-to-br from-blue-400 to-cyan-300 rounded-full flex items-center justify-center text-4xl text-white font-bold shadow-lg">
                                    {userData.name[0]}
                                </div>
                                <div>
                                    <div className="text-2xl font-bold">{userData.name}</div>
                                    <div className="text-gray-500">ç›®å‰ç­‰ç´šï¼šLv. {userData.unlocked}</div>
                                    <div className="text-yellow-600 font-bold mt-1">â­ é‡‘å¹£ï¼š{userData.coins}</div>
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="font-bold text-gray-700 mb-3">ğŸ… ç²å¾—å¾½ç« </h3>
                                <div className="flex gap-2 flex-wrap">
                                    {userData.badges.length === 0 ? <span className="text-gray-400 text-sm">å°šæœªç²å¾—ä»»ä½•å¾½ç« ï¼ŒåŠ æ²¹ï¼</span> :
                                     userData.badges.map((b, i) => (
                                        <span key={i} className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold border border-yellow-300">{b}</span>
                                    ))}
                                </div>
                            </div>

                            <button onClick={submitToGAS} className="w-full py-3 bg-green-500 text-white rounded-xl font-bold text-lg hover:bg-green-600 shadow-md transition flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                ä¸Šå‚³å­¸ç¿’è¨˜éŒ„
                            </button>
                        </div>
                    </div>
                );
            }

            return <div>Loading...</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
